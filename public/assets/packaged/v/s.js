(()=>{var e=self.Ultraviolet,t=["cross-origin-embedder-policy","cross-origin-opener-policy","cross-origin-resource-policy","content-security-policy","content-security-policy-report-only","expect-ct","feature-policy","origin-isolation","strict-transport-security","upgrade-insecure-requests","x-content-type-options","x-download-options","x-frame-options","x-permitted-cross-domain-policies","x-powered-by","x-xss-protection"],r=["GET","HEAD"],i=class extends e.EventEmitter{constructor(t=__uv$config){super(),t.prefix||(t.prefix="/service/"),this.config=t,this.bareClient=new e.BareClient}route({request:e}){return!!e.url.startsWith(location.origin+this.config.prefix)}async fetch({request:i}){let a;try{if(!i.url.startsWith(location.origin+this.config.prefix))return await fetch(i);const c=new e(this.config);"function"==typeof this.config.construct&&this.config.construct(c,"service");const l=await c.cookie.db();c.meta.origin=location.origin,c.meta.base=c.meta.url=new URL(c.sourceUrl(i.url));const d=new n(i,c,r.includes(i.method.toUpperCase())?null:await i.blob());if("blob:"===c.meta.url.protocol&&(d.blob=!0,d.base=d.url=new URL(d.url.pathname)),i.referrer&&i.referrer.startsWith(location.origin)){const e=new URL(c.sourceUrl(i.referrer));(d.headers.origin||c.meta.url.origin!==e.origin&&"cors"===i.mode)&&(d.headers.origin=e.origin),d.headers.referer=e.href}const h=await c.cookie.getCookies(l)||[],u=c.cookie.serialize(h,c.meta,!1);d.headers["user-agent"]=navigator.userAgent,u&&(d.headers.cookie=u);const p=new o(d,null,null);if(this.emit("request",p),p.intercepted)return p.returnValue;a=d.blob?"blob:"+location.origin+d.url.pathname:d.url;const f=await this.bareClient.fetch(a,{headers:d.headers,method:d.method,body:d.body,credentials:d.credentials,mode:d.mode,cache:d.cache,redirect:d.redirect}),m=new s(d,f),g=new o(m,null,null);if(this.emit("beforemod",g),g.intercepted)return g.returnValue;for(const e of t)m.headers[e]&&delete m.headers[e];if(m.headers.location&&(m.headers.location=c.rewriteUrl(m.headers.location)),["document","iframe"].includes(i.destination)){const e=m.getHeader("content-disposition");if(!/\s*?((inline|attachment);\s*?)filename=/i.test(e)){const t=/^\s*?attachment/i.test(e)?"attachment":"inline",[r]=new URL(f.finalURL).pathname.split("/").slice(-1);m.headers["content-disposition"]=`${t}; filename=${JSON.stringify(r)}`}}if(m.headers["set-cookie"]&&(Promise.resolve(c.cookie.setCookies(m.headers["set-cookie"],l,c.meta)).then((()=>{self.clients.matchAll().then((e=>{e.forEach((e=>{e.postMessage({msg:"updateCookies",url:c.meta.url.href})}))}))})),delete m.headers["set-cookie"]),m.body)switch(i.destination){case"script":m.body=c.js.rewrite(await f.text());break;case"worker":{const e=[c.bundleScript,c.clientScript,c.configScript,c.handlerScript].map((e=>JSON.stringify(e))).join(",");m.body=`if (!self.__uv) {\n                                ${c.createJsInject(c.cookie.serialize(h,c.meta,!0),i.referrer)}\n                            importScripts(${e});\n                            }\n`,m.body+=c.js.rewrite(await f.text())}break;case"style":m.body=c.rewriteCSS(await f.text());break;case"iframe":case"document":if(m.getHeader("content-type")&&m.getHeader("content-type").startsWith("text/html")){let e=await f.text();if(Array.isArray(this.config.inject)){const t=e.indexOf("<head>"),r=e.indexOf("<HEAD>"),i=e.indexOf("<body>"),s=e.indexOf("<BODY>"),n=new URL(a),o=this.config.inject;for(const a of o)new RegExp(a.host).test(n.host)&&("head"===a.injectTo?(-1!==t||-1!==r)&&(e=e.slice(0,t)+`${a.html}`+e.slice(t)):"body"===a.injectTo&&(-1!==i||-1!==s)&&(e=e.slice(0,i)+`${a.html}`+e.slice(i)))}m.body=c.rewriteHtml(e,{document:!0,injectHead:c.createHtmlInject(c.handlerScript,c.bundleScript,c.clientScript,c.configScript,c.cookie.serialize(h,c.meta,!0),i.referrer)})}}return"text/event-stream"===d.headers.accept&&(m.headers["content-type"]="text/event-stream"),crossOriginIsolated&&(m.headers["Cross-Origin-Embedder-Policy"]="require-corp"),this.emit("response",g),g.intercepted?g.returnValue:new Response(m.body,{headers:m.headers,status:m.status,statusText:m.statusText})}catch(e){return["document","iframe"].includes(i.destination)?(console.error(e),function(e,t){const r={"content-type":"text/html"};return crossOriginIsolated&&(r["Cross-Origin-Embedder-Policy"]="require-corp"),new Response(function(e,t){const r=`\n        errorTrace.value = ${JSON.stringify(e)};\n        fetchedURL.textContent = ${JSON.stringify(t)};\n        for (const node of document.querySelectorAll("#uvHostname")) node.textContent = ${JSON.stringify(location.hostname)};\n        reload.addEventListener("click", () => location.reload());\n        uvVersion.textContent = ${JSON.stringify("3.2.10")};\n        uvBuild.textContent = ${JSON.stringify("92d9075")};\n    `;return`<!DOCTYPE html>\n        <html>\n        <head>\n        <meta charset='utf-8' />\n        <title>Error</title>\n        <style>\n        * { background-color: white }\n        </style>\n        </head>\n        <body>\n        <h1 id='errorTitle'>Error processing your request</h1>\n        <hr />\n        <p>Failed to load <b id="fetchedURL"></b></p>\n        <p id="errorMessage">Internal Server Error</p>\n        <textarea id="errorTrace" cols="40" rows="10" readonly></textarea>\n        <p>Try:</p>\n        <ul>\n        <li>Checking your internet connection</li>\n        <li>Verifying you entered the correct address</li>\n        <li>Clearing the site data</li>\n        <li>Contacting <b id="uvHostname"></b>'s administrator</li>\n        <li>Verify the server isn't censored</li>\n        </ul>\n        <p>If you're the administrator of <b id="uvHostname"></b>, try:</p>\n        <ul>\n        <li>Restarting your server</li>\n        <li>Updating Ultraviolet</li>\n        <li>Troubleshooting the error on the <a href="https://github.com/titaniumnetwork-dev/Ultraviolet" target="_blank">GitHub repository</a></li>\n        </ul>\n        <button id="reload">Reload</button>\n        <hr />\n        <p><i>Ultraviolet v<span id="uvVersion"></span> (build <span id="uvBuild"></span>)</i></p>\n        <script src="${"data:application/javascript,"+encodeURIComponent(r)}"><\/script>\n        </body>\n        </html>\n        `}(String(e),t),{status:500,headers:r})}(e,a)):new Response(void 0,{status:500})}}static Ultraviolet=e};self.UVServiceWorker=i;var s=class{constructor(e,t){this.request=e,this.raw=t,this.ultraviolet=e.ultraviolet,this.headers={};for(const e in t.rawHeaders)this.headers[e.toLowerCase()]=t.rawHeaders[e];this.status=t.status,this.statusText=t.statusText,this.body=t.body}get url(){return this.request.url}get base(){return this.request.base}set base(e){this.request.base=e}getHeader(e){return Array.isArray(this.headers[e])?this.headers[e][0]:this.headers[e]}},n=class{constructor(e,t,r=null){this.ultraviolet=t,this.request=e,this.headers=Object.fromEntries(e.headers.entries()),this.method=e.method,this.body=r||null,this.cache=e.cache,this.redirect=e.redirect,this.credentials="omit",this.mode="cors"===e.mode?e.mode:"same-origin",this.blob=!1}get url(){return this.ultraviolet.meta.url}set url(e){this.ultraviolet.meta.url=e}get base(){return this.ultraviolet.meta.base}set base(e){this.ultraviolet.meta.base=e}},o=class{#e;#t;constructor(e={},t=null,r=null){this.#e=!1,this.#t=null,this.data=e,this.target=t,this.that=r}get intercepted(){return this.#e}get returnValue(){return this.#t}respondWith(e){this.#t=e,this.#e=!0}}})();